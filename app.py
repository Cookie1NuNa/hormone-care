import streamlit as st
import datetime
import os

# --- 1. 기본 설정 및 함수 ---
DB_FILE = "last_period.txt"

def save_date(date_str):
    with open(DB_FILE, "w", encoding="utf-8") as f:
        f.write(date_str)

def load_date():
    if os.path.exists(DB_FILE):
        with open(DB_FILE, "r", encoding="utf-8") as f:
            return f.read().strip()
    return None

def make_routine(steps):
    return " ➡️ ".join(steps)

def calculate_cycle_day(start_date_str):
    try:
        start_date = datetime.datetime.strptime(start_date_str, "%Y-%m-%d").date()
        today = datetime.date.today()
        delta = today - start_date
        return (delta.days % 28) + 1
    except:
        return None


# --- 2-1. [추가] 건성(제2유형) 전용 상시 업무 지침 ---
def display_dry_skin_habit():
    st.info("### 🍂 2. 에스트로겐 부족형 (긴축 재정의 스타트업)")
    st.caption("※ 이 내용은 생리 주기와 무관하게 **매일 결재(실행)**해야 하는 기본 수칙입니다.")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        **1. 세안 후 '3초 룰' (골든타임)**
        * 수건으로 닦자마자 수분이 날아갑니다.
        * 물기가 살짝 남았을 때 **'디오디너리 히알루론산'**을 바로 바르세요. (욕실에 두고 쓰세요!)
        
        **2. 크림은 '이불'처럼 덮기**
        * 젤 크림만으로는 부족합니다.
        * 저녁엔 **'시카플라스트 밤'**이나 **'마데카 크림'**처럼 꾸덕한 걸로 수분이 못 도망가게 이불을 덮어주세요.
        """)
        
    with col2:
        st.markdown("""
        **3. 아침 세안은 '물'로만**
        * 밤사이에 나온 좋은 기름까지 씻어내지 마세요.
        * 아침엔 클렌징폼 대신 **미지근한 물**로만 씻는 게 피부 장벽을 지키는 비결입니다.
        
        **4. 믹스(Mix) 기술 활용**
        * 피부가 유독 당기는 날엔 크림에 **'페이스 오일'**을 1~2방울 섞으세요.
        
        **🍯 [NEW] 휴대용 소방관 (멀티밤)**
        * 갖고 계신 **'CNP 프로폴리스 밤'**은 건조할 때마다 수시로 바르세요.
        * 눈가, 입가, 팔자 주름, 목주름 등 건조한 부위에 즉시 수분 충전!
        * ⚠️ **주의:** 사용 후엔 티슈로 스틱을 닦아야 트러블이 안 납니다!
        """)
        

# --- 2. [핵심] 내 몸 주식회사 가이드 (친절한 버전) ---
def display_hormone_guide(day):
    st.divider()
    st.markdown(f"#### 🧸 오늘의 보고서: **Day {day}**")
    
    
     # [유형파악] <여성 호르몬 수치별 3가지 유형> (접었다 폈다 할 수 있게)
    with st.expander("ℹ️ <여성 호르몬 수치별 3가지 유형> (나는 어디에 속할까?)"):
        st.caption("사람마다 회사의 '자본금(호르몬 양)'이 다릅니다. 내 유형을 알면 공략법이 보입니다!")
        
        # 탭으로 3가지를 깔끔하게 나눕니다
        tab1, tab2, tab3 = st.tabs(["💖 1. 부자형", "🍂 2. 부족형(나)", "🎸 3. 우세형"])
        
        with tab1:
            st.markdown("""
            ### 💖 1. 에스트로겐 부자형 (자본금 빵빵한 대기업)
            **"여성성 과다 & 드라마 퀸"**
            
            * **🏢 회사 분위기:** "우리 회사는 복지가 화려해!" (인테리어/외관에 투자 많이 함)
            * **👍 장점 (신의 축복):**
                * **동안 피부:** 콜라겐이 넘쳐서 피부가 늙지 않습니다.
                * **S라인:** 가슴과 골반이 발달해 굴곡이 뚜렷합니다.
                * **성격:** 애교가 많고 공감 능력이 뛰어난 분위기 메이커!
            * **👎 단점 (경영 위기):**
                * **감정 쓰나미:** 호르몬 파도가 높아서 기복이 심합니다.
                * **건강:** 생리통이 심하고, 자궁/유방 쪽 이슈가 생기기 쉽습니다. 살찌면 하체부터 찝니다.
            * **💡 CEO 경영 지침:**
                * **"독소를 배출하라!"** (간 해독이 중요합니다. 술 줄이고 **브로콜리, 양배추** 많이 드세요.)
            """)
            
        with tab2:
            st.markdown("""
            ### 🍂 2. 에스트로겐 부족형 (알뜰 살림형 스타트업)
            **"시크하고 쿨함 & 건조 주의보"**
            
            * **🏢 회사 분위기:** "군더더기 없이 실속만 챙겨!" (미니멀리스트 운영)
            * **👍 장점 (신의 축복):**
                * **무통 경영:** 남들이 배 잡고 뒹굴 때 평온합니다. (생리통 거의 없음) 😌
                * **청정 구역:** 피지 분비가 적어서 여드름/개기름 걱정이 없습니다. ✨
            * **👎 단점 (경영 위기):**
                * **사막화:** 얼굴, 눈, 입, 온몸이 바짝바짝 마릅니다.
                * **조기 노화:** 기름칠(유분)이 부족해서 관리 안 하면 잔주름이 빨리 생겨요. 👵
            * **💡 CEO 경영 지침:**
                * **"물만 주지 말고 기름을 줘라!"** (페이스 오일 필수 💧+🛢️)
                * **"외부 투자 유치!"** (콩, 두유, 석류, 칡즙 등 **에스트로겐 식품** 섭취 필수 🍒)
            """)
            
        with tab3:
            st.markdown("""
            ### 🎸 3. 안드로겐 우세형 (전투적인 경쟁 기업)
            **"걸크러쉬 & 트러블 메이커"**
            
            * **🏢 회사 분위기:** "시스템 오류가 잦지만 에너지는 넘쳐!" (다낭성 등)
            * **👍 장점 (신의 축복):**
                * **근수저:** 근육이 잘 붙고 운동 효과가 빠릅니다.
                * **리더십:** 털털하고 승부욕이 있으며 추진력이 좋습니다.
            * **👎 단점 (경영 위기):**
                * **피지 폭발:** 턱 주변 여드름, 지성 피부가 고민입니다.
                * **건강:** 살이 찌면 배(복부)부터 찌고, 생리 주기가 불규칙합니다.
            * **💡 CEO 경영 지침:**
                * **"당(Sugar)을 끊어라!"** (탄수화물 줄이는 게 최고의 호르몬 치료입니다. 빵/떡 금지 🍞❌)
            """)
            
    # [친절한 안내] 세계관 설명 (접었다 폈다 할 수 있게)
    with st.expander("ℹ️ '내 몸 주식회사'가 뭔가요? (처음 오셨다면 필독!)"):
        st.markdown("""
        **우리 몸을 하나의 '회사'라고 상상해 보세요!** 🏢
        매달 '임신'이라는 프로젝트를 위해 직원(호르몬)들이 열심히 일하고 있어요.
        
        * **인사팀장 (FSH):** 생리 때 잠든 난자를 깨우는 **'기상 나팔'** 🎺
        * **홍보이사 (에스트로겐):** 생리 후 피부와 기분을 좋게 만드는 **'미모 담당'** ✨
        * **이벤트팀장 (LH):** 배란일에 난자를 내보내는 **'폭죽 담당'** 🎉
        * **보안팀장 (프로게스테론):** 배란 후 몸을 붓게 하고 지키는 **'방어 담당'** 🛡️
        
        이들의 출근 스케줄에 맞춰서 피부 관리와 컨디션 조절을 하면 훨씬 효과적이랍니다!
        """)

    # [통합요약]
    with st.expander(" ⬇ 이번 달 요약 미리보기 (Click)"):
        st.markdown("""
        * **📉 생리기 (1~5일):** "파업 & 대청소 중" ➡️ 푹 쉬고 물 많이 드세요.
        * **📈 난포기 (6~13일):** "황금기 & 리즈 갱신" ➡️ 다이어트, 고기능성 화장품, 시술 OK! ✨
        * **🚩 배란기 (14~16일):** "파티 & 개기름 주의" ➡️ 매력적이지만 피지 조심하세요.
        * **🛡️ 황체기 (17~28일):** "방어 모드 & 존버" ➡️ 자외선 차단 필수, 트러블 손대지 마세요.
        """)

    # --- 구간별 스토리텔링 시작 ---

    # 1. 생리기 (Day 1 ~ 5)
    if 1 <= day <= 5:
        st.error(f"### 🩸 1. 생리기: 대청소 & 휴식 기간 (Day {day})")
        st.caption("🏢 현재 상황: 호르몬 직원들이 다 퇴근하고 청소(생리) 중이에요.")
        
        if day <= 2:
            st.markdown("#### 🚨 1단계: 폭풍의 시작 (Day 1~2)")
            st.info("""
            **💬 현실 해석:**
            호르몬 수치가 바닥이라 **몸도 기분도 축 처지는 날**입니다.
            배가 아프고 까칠해지는 건 당연한 거니까, 자책하지 말고 푹 쉬세요.
            """)
            st.markdown("""
            **🧖‍♀️ [피부팀 보고] "사장님, 지금은 건드리면 안 됩니다!"**
            * 피부 방어막이 약해져서 엄청 예민하고 건조해요.
            """)
            col1, col2 = st.columns(2)
            with col1:
                st.success("**✅ 해요:**\n* **물 주기:** 순한 수분 크림 듬뿍!\n* **온열 팩:** 배를 따뜻하게 해주세요.")
            with col2:
                st.error("**❌ 마요:**\n* **기능성 화장품:** 비타민, 주름 개선제는 따가워요.\n* **새 화장품:** 오늘은 참으세요.")
            
            st.write("---")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.write(f"🌙 저녁: {make_routine(['토너', '💧디오디너리 히알루론산', '🛡️마데카/시카밤(듬뿍)'])}")
            
        elif day <= 4:
            st.markdown("#### 🧹 2단계: 조금씩 살아나는 중 (Day 3~4)")
            st.info("""
            **💬 현실 해석:**
            가장 힘든 고비는 넘겼어요! 통증은 줄었지만, 몸에 수분이 빠져나가서 **엄청 건조한 상태**입니다.
            """)
            st.markdown("""
            **🧖‍♀️ [피부팀 보고] "물! 물을 주세요!"**
            * 트러블은 가라앉았지만, 얼굴이 푸석푸석해요.
            """)
            st.success("**✅ 꿀팁:** 자극 없는 **수분 마스크팩** 하나면 충분합니다.")
            st.error("**❌ 주의:** 화장 뜬다고 각질 제거하면 얼굴 뒤집어져요!")
            
            st.write("---")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.write(f"🌙 저녁: {make_routine(['토너', '🧖‍♀️수분 마스크팩', '💧디오디너리 히알루론산', '🛡️마데카/시카밤'])}")
            
        else: # Day 5
            st.markdown("#### 🌱 3단계: 황금기 준비 (Day 5)")
            st.info("""
            **💬 현실 해석:**
            드디어 몸이 가벼워지기 시작합니다! 내일부터 시작될 **'피부 전성기'**를 위해 미리 준비운동을 하는 날이에요.
            """)
            st.markdown("""
            **🧖‍♀️ [피부팀 보고] "광낼 준비 됐습니다!"**
            * 혈색이 돌아오고 피부 결이 매끄러워지고 있어요.
            """)
            st.success("""
            **✅ 할 일:**
            * **살살 청소:** 내일 비싼 화장품 잘 먹으라고, 묵은 각질을 부드럽게(효소 세안제 등) 제거해주세요.
            * **미백 시동:** 비타민C 앰플 꺼내두세요!
            """)
            st.write("---")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.write(f"🌙 저녁: {make_routine(['📍효소파우더', '토너', '💧디오디너리 히알루론산', '마데카/시카밤'])}")

    # 2. 난포기 (Day 6 ~ 13)
    elif 6 <= day <= 13:
        st.success(f"### 📈 2. 난포기: 황금기 & 리즈 갱신 (Day {day})")
        st.caption("🏢 현재 상황: 에스트로겐(미모 담당)이 출근해서 지원금을 펑펑 쓰고 있어요! ✨")
        
        st.info("""
        **💬 현실 해석:**
        **피부와 컨디션이 최고로 좋은 시기**입니다. 회복력이 빨라서 뭘 해도 잘 돼요.
        다이어트, 소개팅, 피부과 시술, 비싼 화장품... 다 지금 하세요!
        """)

        # 일자별 상세 루틴 (Day 6~9) -> [실제 화장품 적용]
        if day == 6:
            st.markdown("#### 🚀 Day 6: 코스알엑스 비타민C 23 (잡티 완화)")
            st.write("**목표:** 칙칙했던 얼굴에 고농도 비타민 투여! (약간 따가울 수 있음)")
            # [수정] 집에 있는 '토리든'으로 명시!
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.warning(f"🌙 루틴: {make_routine(['토너', '🍋코스알엑스 비타민C', '🧖‍♀️토리든 마스크팩', '🛡️마데카/시카밤'])}")
            
        elif day == 7:
            st.markdown("#### 🚀 Day 7: 디오디너리 알부틴 + 기기 (톤 정리)")
            st.write("**목표:** 뷰티 디바이스가 있다면 오늘이 기회입니다. 알부틴을 피부 깊숙이 밀어 넣으세요.")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.warning(f"🌙 루틴: {make_routine(['토너', '💧디오디너리 히알루론산', '💡디오디너리 알부틴(+기기먼저)', '마데카/시카밤'])}")
            
        elif day == 8:
            st.markdown("#### 🚀 Day 8: VT 리들샷 300 (재생, 길 뚫기)")
            st.write("**목표:** 회복력이 좋을 때라 따가운 니들샷 쓰기 딱 좋습니다.")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.warning(f"🌙 루틴: {make_routine(['⚡VT 리들샷(맨얼굴)', '토너', '💧디오디너리 히알루론산', '🛡️시카밤(듬뿍)'])}")
            st.error("⚠️ 주의: 리들샷 한 날은 비타민C 절대 금지! 오직 수분과 재생만!")
            
        elif day == 9:
            st.markdown("#### 🚀 Day 9: 나이아신아마이드 (모공 쫀쫀)")
            st.write("**목표:** 건조하지 않게 모공 관리하기. (앰플 단독 사용 X, 크림에 섞어서!)")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.warning(f"🌙 루틴: {make_routine(['토너', '💧디오디너리 히알루론산', '🧴크림+나이아신 믹스', '크림한겹 더 덮기'])}")
            
        else: # Day 10~13
            st.markdown("#### ✨ 2단계: 물광 코팅 (Day 10~13)")
            st.write("**👉 전략:** 곧 다가올 배란기(개기름)에 대비해서, **유수분 밸런스**를 맞춰두는 시기입니다.")
            st.success("""
            **💡 꿀팁:**
            * **앰플 먼저:** 마스크팩 붙이기 전에 히알루론산을 먼저 깔면 흡수율 폭발!
            * **크림 조절:** 13일쯤 되면 피지가 슬슬 올라오니 꾸덕한 크림 양을 조금 줄이세요.
            """)
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.warning(f"🌙 루틴: {make_routine(['토너', '💧디오디너리 히알루론산', '🧖‍♀️수분 마스크팩', '마데카'])}")

    # 3. 배란기 & 체제 전환 (Day 14 ~ 16)
    elif 14 <= day <= 16:
        st.warning(f"### 🎉 3. 배란기: 화려한 파티 & 피지 주의보 (Day {day})")
        
        if day == 14:
            st.caption("🏢 현재 상황: 난자(신제품) 출시 파티 중! 폭죽 터지고 난리 났어요.")
            st.info("""
            **💬 현실 해석:**
            가장 매력적이고 예뻐 보이는 날이지만, **피지(개기름)가 폭발**하는 날이기도 합니다.
            건성 피부도 오늘은 코 주변이 번들거릴 수 있어요.
            """)
            st.markdown("#### 🚨 오늘 미션: 개기름 청소 & 열 내리기")
            
            col1, col2 = st.columns(2)
            with col1:
                st.success("""
                **✅ 해요 (비우기):**
                * **오일 클렌징:** 코 주변 블랙헤드 녹여주기 (롤링 1분)
                * **쿨링:** 얼굴 온도 낮추기 (모델링팩, 차가운 팩)
                """)
            with col2:
                st.error("""
                **❌ 마요 (참기):**
                * **머드/클레이 팩:** 건성 피부는 너무 건조해져요!
                * **짜지 마세요:** 흉터 오래 남습니다.
                """)
            st.write("---")
            # [수정] 머드팩 삭제 -> 모델링팩(쿨링) or 토리든으로 변경
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.warning(f"🌙 루틴: {make_routine(['오일클렌징(코 집중)', '토너', '🧊모델링팩(또는 토리든)', '프리메이 수분크림'])}")
            
        else: # Day 15~16
            st.caption("🧹 파티 끝! 열 식히는 중")
            st.info("""
            **💬 현실 해석:**
            배란이 끝나고 **몸이 뜨끈뜨끈**해지기 시작합니다. (체온 상승)
            열 때문에 모공이 넓어지고 피지가 굳을 수 있으니 식혀줘야 해요.
            """)
            st.success("✅ **추천:** 알로에 젤이나 차가운 토너로 얼굴 온도 낮추기")
            st.write("---")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.warning(f"🌙 루틴: {make_routine(['🧊차가운 토너(닥토!)', '💧디오디너리 히알루론산', '알로에/프리메이', '🛡️시카밤(얇게)'])}")

    # 4. 황체기 (Day 17 ~ 28)
    else:
        st.info(f"### 🛡️ 4. 황체기: 방어 모드 & 존버 (Day {day})")
        st.caption("👮‍♂️ 현재 상황: 보안팀장이 문 잠그고 비상식량(수분, 지방) 쟁여두는 중.")
        
        st.markdown("""
        **💬 현실 해석:**
        몸이 붓고, 살이 찌고, 예민해지는 시기입니다. (내 탓 아니에요!)
        건성 피부는 이때 **피부가 가장 메말라 보일 수 있으니** 오일 보습에 신경 쓰세요.
        """)

        if day <= 22:
            st.markdown("#### 🧱 1단계: 햇빛 & 건조 방어 (Day 17~22)")
            st.write("기미가 생기기 쉽고 피부가 거칠어지는 시기입니다.")
            st.warning("""
            **🧖‍♀️ [피부팀 전략]**
            * 선크림은 무조건 꼼꼼하게!
            * 건조함이 심하면 **페이스 오일**을 크림에 섞으세요.
            """)
            st.write("---")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림(두껍게!!)'])}")
            st.info(f"🌙 루틴: {make_routine(['토너', '💧디오디너리 히알루론산', '🛡️마데카/세타필', '🧊모델링팩(선택)'])}")
            
        else: # Day 23~28
            st.markdown("#### 🚨 2단계: 폭동 전야 (생리 전) (Day 23~28)")
            st.error("""
            **💬 현실 해석:**
            호르몬이 뚝 떨어지면서 **짜증이 나고 피부 트러블이 올라오는** 최악의 시기입니다.
            턱이나 입 주변에 뭐가 나도 **절대 건드리지 마세요.**
            """)
            st.markdown("""
            **🧖‍♀️ [피부팀 긴급 지침] "손 대지 마시오!"**
            * 화장품 단계를 최소화하세요. 많이 바르면 피부가 체합니다.
            * 붉은 게 올라오면 트러블 패치 붙이고 끝내세요.
            """)
            st.write("---")
            st.write(f"☀️ 아침: {make_routine(['물세안', '💧디오디너리 히알루론산', '프리메이 수분크림', '🧴선크림'])}")
            st.info(f"🌙 루틴: {make_routine(['약산성 세안', '토너', '🛡️시카밤(하나만)', '트러블패치'])}")

    # 공통 하단 메시지
    st.divider()
    st.caption("💪 오늘도 내 몸 주식회사의 CEO로서 파이팅하세요!")

# --- 3. 메인 실행 화면 ---
st.header("📑 내 몸 경영 전략보고서")

saved_date = load_date()

# 사이드바 설정 부분
with st.sidebar:
    # 1. 타이틀 (사용자 명패)
    st.title("🆔 ID Card")
    
    # 이름을 입력받아서 변수에 저장 (기본값: CEO)
    user_name = st.text_input("성함(직함)을 입력하세요", value="대표이사")
    
    st.success(f"반갑습니다, **{user_name}** 님! 👋")
    
    st.divider() # 구분선
    
    # 2. 기존 설정 메뉴
    st.header("⚙️ CEO 집무실 (설정)")
    
    # ... (나머지 코드)
    if saved_date:
        st.write(f"📅 마지막 대청소 시작일(생리): `{saved_date}`")
    
    new_date = st.date_input("날짜 수정하기", 
                             value=datetime.datetime.strptime(saved_date, "%Y-%m-%d").date() if saved_date else datetime.date.today())
    
    if st.button("결재(저장)"):
        save_date(str(new_date))
        st.success("승인 완료! 새로고침됩니다.")
        st.rerun()

# 메인 로직 실행
if saved_date:
    current_day = calculate_cycle_day(saved_date)
    
    # [추가] 사이드바에서 입력받은 이름(user_name)을 제목에 반영!
    st.title(f"📑 {user_name}의 경영 전략보고서") 
    
    if current_day:
        
        display_dry_skin_habit() # 상시 지침 (건성)
        
        st.divider() # 구분선 하나 넣어주면 더 깔끔합니다
        
        display_hormone_guide(current_day) # 오늘의 리포트
    else:
        st.error("시스템 오류: 날짜 형식을 확인하세요.")
else:
    # 날짜 입력 전 대기 화면
    st.title(f"👋 환영합니다, {user_name} 님!")
    st.warning("👈 왼쪽 메뉴에서 '마지막 생리 시작일'을 입력하고 결재를 눌러주세요!")