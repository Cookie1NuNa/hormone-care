import streamlit as st
import datetime
import os

# --- 1. 기본 설정 및 함수 ---
DB_FILE = "last_period.txt"

def save_date(date_str):
    with open(DB_FILE, "w", encoding="utf-8") as f:
        f.write(date_str)

def load_date():
    if os.path.exists(DB_FILE):
        with open(DB_FILE, "r", encoding="utf-8") as f:
            return f.read().strip()
    return None

def make_routine(steps):
    return " ➡️ ".join(steps)

def calculate_cycle_day(start_date_str):
    try:
        start_date = datetime.datetime.strptime(start_date_str, "%Y-%m-%d").date()
        today = datetime.date.today()
        delta = today - start_date
        return (delta.days % 28) + 1
    except:
        return None

# --- 2. [핵심] 내 몸 주식회사 가이드 (친절한 버전) ---
def display_hormone_guide(day):
    st.divider()
    st.markdown(f"#### 🧸 오늘의 보고서: **Day {day}**")
    
    # [친절한 안내] 세계관 설명 (접었다 폈다 할 수 있게)
    with st.expander("ℹ️ '내 몸 주식회사'가 뭔가요? (처음 오셨다면 필독!)"):
        st.markdown("""
        **우리 몸을 하나의 '회사'라고 상상해 보세요!** 🏢
        매달 '아기 만들기'라는 프로젝트를 위해 직원(호르몬)들이 열심히 일하고 있어요.
        
        * **인사팀장 (FSH):** 생리 때 잠든 난자를 깨우는 **'기상 나팔'** 🎺
        * **홍보이사 (에스트로겐):** 생리 후 피부와 기분을 좋게 만드는 **'미모 담당'** ✨
        * **이벤트팀장 (LH):** 배란일에 난자를 내보내는 **'폭죽 담당'** 🎉
        * **보안팀장 (프로게스테론):** 배란 후 몸을 붓게 하고 지키는 **'방어 담당'** 🛡️
        
        이들의 출근 스케줄에 맞춰서 피부 관리와 컨디션 조절을 하면 훨씬 효과적이랍니다!
        """)

    # [통합요약]
    with st.expander(" ⬇️ 이번 달 요약 미리보기 (Click)"):
        st.markdown("""
        * **📉 생리기 (1~5일):** "파업 & 대청소 중" ➡️ 푹 쉬고 물 많이 드세요.
        * **📈 난포기 (6~13일):** "황금기 & 리즈 갱신" ➡️ 다이어트, 고기능성 화장품, 시술 OK! ✨
        * **🚩 배란기 (14~16일):** "파티 & 개기름 주의" ➡️ 매력적이지만 피지 조심하세요.
        * **🛡️ 황체기 (17~28일):** "방어 모드 & 존버" ➡️ 자외선 차단 필수, 트러블 손대지 마세요.
        """)

    # --- 구간별 스토리텔링 시작 ---

    # 1. 생리기 (Day 1 ~ 5)
    if 1 <= day <= 5:
        st.error(f"### 🩸 1. 생리기: 대청소 & 휴식 기간 (Day {day})")
        st.caption("🏢 현재 상황: 호르몬 직원들이 다 퇴근하고 청소(생리) 중이에요.")
        
        if day <= 2:
            st.markdown("#### 🚨 1단계: 폭풍의 시작 (Day 1~2)")
            st.info("""
            **💬 현실 해석:**
            호르몬 수치가 바닥이라 **몸도 기분도 축 처지는 날**입니다.
            배가 아프고 까칠해지는 건 당연한 거니까, 자책하지 말고 푹 쉬세요.
            """)
            st.markdown("""
            **🧖‍♀️ [피부팀 보고] "사장님, 지금은 건드리면 안 됩니다!"**
            * 피부 방어막이 약해져서 엄청 예민하고 건조해요.
            """)
            col1, col2 = st.columns(2)
            with col1:
                st.success("**✅ 해요:**\n* **물 주기:** 순한 수분 크림 듬뿍!\n* **온열 팩:** 배를 따뜻하게 해주세요.")
            with col2:
                st.error("**❌ 마요:**\n* **기능성 화장품:** 비타민, 주름 개선제는 따가워요.\n* **새 화장품:** 오늘은 참으세요.")
            
            st.write("---")
            st.write(f"☀️ 아침: {make_routine(['토너', '히알루론산', '프리메이크림', '썬크림'])}")
            st.write(f"🌙 저녁: {make_routine(['토너', '히알루론산', '마데카+시카(진정)'])}")
            
        elif day <= 4:
            st.markdown("#### 🧹 2단계: 조금씩 살아나는 중 (Day 3~4)")
            st.info("""
            **💬 현실 해석:**
            가장 힘든 고비는 넘겼어요! 통증은 줄었지만, 몸에 수분이 빠져나가서 **엄청 건조한 상태**입니다.
            """)
            st.markdown("""
            **🧖‍♀️ [피부팀 보고] "물! 물을 주세요!"**
            * 트러블은 가라앉았지만, 얼굴이 푸석푸석해요.
            """)
            st.success("**✅ 꿀팁:** 자극 없는 **수분 마스크팩** 하나면 충분합니다.")
            st.error("**❌ 주의:** 화장 뜬다고 각질 제거하면 얼굴 뒤집어져요!")
            
            st.write("---")
            st.write(f"🌙 저녁: {make_routine(['토너', '마스크팩(수분)', '히알루론산', '마데카+시카(듬뿍)'])}")
            
        else: # Day 5
            st.markdown("#### 🌱 3단계: 황금기 준비 (Day 5)")
            st.info("""
            **💬 현실 해석:**
            드디어 몸이 가벼워지기 시작합니다! 내일부터 시작될 **'피부 전성기'**를 위해 미리 준비운동을 하는 날이에요.
            """)
            st.markdown("""
            **🧖‍♀️ [피부팀 보고] "광낼 준비 됐습니다!"**
            * 혈색이 돌아오고 피부 결이 매끄러워지고 있어요.
            """)
            st.success("""
            **✅ 할 일:**
            * **살살 청소:** 내일 비싼 화장품 잘 먹으라고, 묵은 각질을 부드럽게(효소 세안제 등) 제거해주세요.
            * **미백 시동:** 비타민C 앰플 꺼내두세요!
            """)
            st.write("---")
            st.write(f"🌙 저녁: {make_routine(['📍효소파우더(각질정리)', '토너', '히알루론산', '크림'])}")

    # 2. 난포기 (Day 6 ~ 13)
    elif 6 <= day <= 13:
        st.success(f"### 📈 2. 난포기: 황금기 & 리즈 갱신 (Day {day})")
        st.caption("🏢 현재 상황: 에스트로겐(미모 담당)이 출근해서 지원금을 펑펑 쓰고 있어요! ✨")
        
        st.info("""
        **💬 현실 해석:**
        **피부와 컨디션이 최고로 좋은 시기**입니다. 회복력이 빨라서 뭘 해도 잘 돼요.
        다이어트, 소개팅, 피부과 시술, 비싼 화장품... 다 지금 하세요!
        """)

        # 일자별 상세 루틴 (Day 6~9) -> [수정] 제목을 화장품 이름으로 변경
        if day == 6:
            st.markdown("#### 🚀 Day 6: 비타민C 앰플(🍋) (잡티 완화)")
            st.write("**목표:** 칙칙했던 얼굴에 비타민 투여! 조명을 켜세요.")
            st.warning(f"🌙 루틴: {make_routine(['토너', '📍비타민C 앰플', '마스크팩(수분)', '마데카+시카'])}")
            
        elif day == 7:
            st.markdown("#### 🚀 Day 7: 초음파기기 + 알부틴 (기미, 입가, 톤정리)")
            st.write("**목표:** 뷰티 디바이스가 있다면 오늘이 기회입니다. 쭉쭉 밀어 넣으세요.")
            st.warning(f"🌙 루틴: {make_routine(['토너', '히알루론산(베이스)', '📍초음파기기 + 알부틴', '크림'])}")
            
        elif day == 8:
            st.markdown("#### 🚀 Day 8: 니들샷 (재생, 흡수력)")
            st.write("**목표:** 회복력이 좋을 때라 따가운 제품(니들샷)으로 길 뚫기 딱 좋습니다.")
            st.warning(f"🌙 루틴: {make_routine(['📍니들샷(맨얼굴)', '토너', '히알루론산', '재생크림'])}")
            st.error("⚠️ 주의: 니들샷 한 날은 비타민C나 레티놀 같이 자극적인 건 피하세요! (수분/재생 올인)")
            
        elif day == 9:
            st.markdown("#### 🚀 Day 9: 나이아신아마이드 (모공)")
            st.write("**목표:** 어제 뚫어놓은 길로 '나이아신'을 넣어 모공을 쪼여주세요.")
            st.warning(f"🌙 루틴: {make_routine(['토너', '히알루론산', '📍나이아신아마이드', '크림'])}")
            
        else: # Day 10~13
            st.markdown("#### ✨ 2단계: 물광 코팅 (Day 10~13)")
            st.write("**👉 전략:** 곧 다가올 배란기(개기름)에 대비해서, **유수분 밸런스**를 맞춰두는 시기입니다.")
            st.success("""
            **💡 꿀팁:**
            * **앰플 먼저:** 마스크팩 붙이기 전에 앰플을 먼저 바르면 효과가 2배!
            * **크림은 적당히:** 13일쯤 되면 피지가 슬슬 올라오니 크림 양을 조금 줄이세요.
            """)
            st.warning(f"🌙 루틴: {make_routine(['토너', '💧히알루론산(팩 전)', '🧖‍♀️수분 마스크팩', '마데카+시카(얇게)'])}")

    # 3. 배란기 & 체제 전환 (Day 14 ~ 16)
    elif 14 <= day <= 16:
        st.warning(f"### 🎉 3. 배란기: 화려한 파티 & 피지 주의보 (Day {day})")
        
        if day == 14:
            st.caption("🏢 현재 상황: 난자(신제품) 출시 파티 중! 폭죽 터지고 난리 났어요.")
            st.info("""
            **💬 현실 해석:**
            가장 매력적이고 예뻐 보이는 날이지만, **피지(개기름)가 폭발**하는 날이기도 합니다.
            겉은 번들거리고 속은 당길 수 있어요.
            """)
            st.markdown("#### 🚨 오늘 미션: 개기름 청소하기")
            
            col1, col2 = st.columns(2)
            with col1:
                st.success("""
                **✅ 해요 (비우기):**
                * **딥 클렌징:** 모공 속까지 꼼꼼하게!
                * **쿨링/머드팩:** 열 내리고 피지 빨아들이기
                * **수분 젤:** 가볍고 산뜻하게 마무리
                """)
            with col2:
                st.error("""
                **❌ 마요 (참기):**
                * **오일/영양크림:** 오늘은 기름집니다.
                * **짜지 마세요:** 흉터 오래 남아요.
                * **충동구매:** 지갑 닫으세요!
                * **야식:** 식욕 폭발 주의!
                """)
            st.write("---")
            st.warning(f"🌙 루틴: {make_routine(['오일클렌징/효소파우더', '닦는 토너', '🧊모델링/머드팩', '수분젤크림'])}")
            
        else: # Day 15~16
            st.caption("🧹 파티 끝! 열 식히는 중")
            st.info("""
            **💬 현실 해석:**
            배란이 끝나고 **몸이 뜨끈뜨끈**해지기 시작합니다. (체온 상승)
            열 때문에 모공이 넓어지고 피지가 굳을 수 있으니 식혀줘야 해요.
            """)
            st.success("""
            **✅ 꿀팁:**
            * **쿨링:** 알로에 젤이나 차가운 토너로 얼굴 온도를 낮춰주세요.
            * **진정:** 시카, 티트리, 어성초 같은 진정 성분이 좋습니다.
            """)
            st.write("---")
            st.warning(f"🌙 루틴: {make_routine(['차가운 토너', '수분 앰플', '알로에 젤(두껍게)', '시카 크림'])}")

    # 4. 황체기 (Day 17 ~ 28)
    else:
        st.info(f"### 🛡️ 4. 황체기: 방어 모드 & 존버 (Day {day})")
        st.caption("👮‍♂️ 현재 상황: 보안팀장이 문 잠그고 비상식량(수분, 지방) 쟁여두는 중.")
        
        st.markdown("""
        **💬 현실 해석:**
        몸이 붓고, 살이 찌고, 예민해지는 시기입니다. (내 탓 아니에요!)
        몸무게가 1~2kg 늘어날 수 있는데, 지방이 아니라 **물(붓기)**이니까 너무 스트레스 받지 마세요.
        """)
        st.success("""
        **✅ 생활 수칙:**
        * **싱겁게 먹기:** 짠 거 먹으면 풍선처럼 부어요.
        * **순환 운동:** 림프 마사지, 스트레칭으로 붓기 빼주기.
        * **결정 미루기:** 퇴사, 이별, 앞머리 자르기는 다음 주에 결정하세요. (지금 기분은 가짜!)
        """)

        if day <= 22:
            st.markdown("#### 🧱 1단계: 햇빛 방어 (Day 17~22)")
            st.write("기미, 주근깨가 생기기 딱 좋은 때입니다.")
            st.warning("""
            **🧖‍♀️ [피부팀 보고]**
            * **자외선 차단제**를 평소보다 두껍게 바르세요. (양산/모자 추천)
            * **클레이 팩**으로 막힌 모공을 한 번씩 청소해주세요.
            """)
            st.write("---")
            st.info(f"🌙 루틴: {make_routine(['토너', '진정 앰플', '수분 크림', '모델링팩(선택)'])}")
            
        else: # Day 23~28
            st.markdown("#### 🚨 2단계: 폭동 전야 (생리 전) (Day 23~28)")
            st.error("""
            **💬 현실 해석:**
            호르몬이 뚝 떨어지면서 **짜증이 나고 피부 트러블이 올라오는** 최악의 시기입니다.
            턱이나 입 주변에 뭐가 나도 **절대 건드리지 마세요.**
            """)
            st.markdown("""
            **🧖‍♀️ [피부팀 긴급 지침] "손 대지 마시오!"**
            * 화장품 개수를 확 줄이세요. (피부 체함)
            * 붉게 올라오면 **트러블 패치**만 붙이고 거울 보지 마세요.
            """)
            st.write("---")
            st.info(f"🌙 루틴: {make_routine(['약산성 세안', '토너', '시카 크림(하나만)', '트러블패치'])}")

    # 공통 하단 메시지
    st.divider()
    st.caption("💪 오늘도 내 몸 주식회사의 CEO로서 파이팅하세요!")

# --- 3. 메인 실행 화면 ---
st.header("📑 내 몸 경영 전략보고서")

saved_date = load_date()

# 사이드바 설정
with st.sidebar:
    st.header("⚙️ 설정 (CEO 집무실)")
    if saved_date:
        st.write(f"📅 마지막 대청소 시작일(생리): `{saved_date}`")
    
    new_date = st.date_input("날짜 수정하기", 
                             value=datetime.datetime.strptime(saved_date, "%Y-%m-%d").date() if saved_date else datetime.date.today())
    
    if st.button("결재(저장)"):
        save_date(str(new_date))
        st.success("승인 완료! 새로고침됩니다.")
        st.rerun()

# 메인 로직 실행
if saved_date:
    current_day = calculate_cycle_day(saved_date)
    if current_day:
        display_hormone_guide(current_day)
    else:
        st.error("시스템 오류: 날짜 형식을 확인하세요.")
else:
    st.warning("👈 왼쪽 메뉴에서 마지막 생리 시작일을 입력해주세요!")